<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GSI Gorillas Trening</title>
  <style>
    :root{--bg:#0b1016;--card:#121924;--muted:#94a3b8;--text:#e5e7eb;--accent:#2563eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Inter,Arial,sans-serif;background:#0b1016;color:#e5e7eb}
    header{padding:20px 16px;border-bottom:1px solid #18202b}
    h1{margin:0;font-size:clamp(22px,4vw,28px)}
    .wrap{max-width:1500px;margin:0 auto;padding:16px}
    /* Pages */
    .pages{display:block}
    .page{display:none}
    .page.active{display:block}
    /* Cards + layout */
    .card{background:#121924;border:1px solid #1e293b;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);margin-bottom:16px}
    .card .inner{padding:14px}
    label{display:block;font-size:12px;color:#94a3b8;margin:8px 0 6px}
    input,button{border-radius:10px;border:1px solid #253346;background:#0f172a;color:#e5e7eb;padding:10px 12px}
    button{cursor:pointer}
    .primary{background:#2563eb;border:0}
    .ghost{background:transparent;border:1px dashed #334155}
    .row{display:flex;gap:8px;align-items:center}
    .row>*{flex:1}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
    .toolbar .spacer{flex:1}
    .list{display:grid;gap:6px;max-height:420px;overflow:auto}
    .player{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #223046;border-radius:10px;background:#0d1524;position:relative}
    .small{font-size:12px;color:#94a3b8}
    /* Matches grid */
    .matches{display:grid;gap:56px;padding: 16px 28px 36px}
    @media(min-width:900px){.matches{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .match{border:1px solid #233049;border-radius:12px;overflow:hidden;background:#0e1626;margin-bottom:10px}
    .match header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #1e293b}
    .teams{padding:10px 12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2a33;text-align:left}
    th{position:sticky;top:0;background:#0f172a}
    /* --- Padelbane-stil per kamp --- */
    .court{
      margin:10px 12px;
      display:grid;
      grid-template-columns:1fr 8px 1fr; gap:0; border-radius:14px; overflow:hidden; margin:20px 24px; background:
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px) 0 0/25% 100%,
        linear-gradient(0deg, rgba(255,255,255,0.05) 1px, transparent 1px) 0 0/100% 25%,
        radial-gradient(ellipse at center, rgba(37,99,235,0.12), rgba(0,0,0,0) 60%);
      border:1px solid #203050;
    }
    .court .side{
      padding:14px 12px 18px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:8px;
      min-height:110px;
      position:relative;
      align-items:center;
      text-align:center;
      background:linear-gradient(180deg, rgba(21,32,52,.35), rgba(10,15,25,.2));
    }
    .court .net{ background:#e5e7eb; filter:opacity(.85);}
    .court .playerTag{
      padding:6px 10px;
      border-radius:10px;
      background:#0b1220;
      border:1px solid #223046;
      box-shadow:0 2px 8px rgba(0,0,0,.25);
      font-size:14px;
      white-space:nowrap;
      text-align:center;
    }
    /* --- Kebab meny --- */
    .menu-btn{
      width:36px;height:36px;border-radius:10px;border:1px solid #334155;background:#0f172a;display:inline-flex;align-items:center;justify-content:center
    }
    .menu-btn:after{content:'⋮';font-size:18px;line-height:1}
    .menu{position:absolute;right:8px;top:44px;min-width:160px;background:#0b1220;border:1px solid #223046;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:6px;display:none;z-index:5}
    .menu.open{display:block}
    .menu button{width:100%;text-align:left;border:0;background:transparent;padding:8px 10px;border-radius:8px}
    .menu button:hover{background:#132032}
    .menu hr{border:0;border-top:1px solid #223046;margin:6px 0}
    .pts-click{cursor:pointer}
    /* Controls wrap for roster */
    .controls{flex-wrap:wrap}
    .controls #searchName{flex:1 0 100%}
    .controls button{margin-top:6px}
    /* Simple top nav (optional) */
    nav.top{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    nav.top a{padding:8px 10px;border:1px solid #334155;border-radius:10px;text-decoration:none;color:var(--text);background:#0f172a}
    nav.top a.active{background:#2563eb;border-color:#2563eb}
    

  
    /* Overstyr bredde på 'Legg til spiller'-feltet */
    #addForm > input#newName { flex: 1 1 auto; max-width: 100%; }
    #addForm > button#addPlayer { flex: 0 0 auto !important; }

  
    
      #addForm > input#newName { flex: 0 0 360px; max-width: 360px; }
      #addForm > button#addPlayer { flex: 0 0 auto; }
    }

  
    
    #addForm > input#newName { flex: 0 0 360px !important; max-width: 360px !important; }
    #addForm > button#addPlayer { flex: 0 0 auto !important; }
    @media (max-width: 600px){
      #addForm > input#newName { flex: 1 1 auto !important; max-width: 100% !important; }
    }

  
    /* Bredde som før vi delte inn i sider */
    #addForm { gap: 8px; }
    #addForm > * { flex: 0 0 auto; }
    #addForm > input#newName { flex: 0 0 380px; max-width: 380px; }
    #addForm > button#addPlayer { flex: 0 0 auto; }
    @media (max-width: 600px){
      #addForm > * { flex: 1 1 auto; }
      #addForm > input#newName { max-width: 100%; }
      #addForm > button#addPlayer { flex: 0 0 auto; }
    }

  
    /* Gjør spiller-vinduet smalere og sentrert */
    #page-players .card { max-width: 820px; margin: 0 auto; }

  
  
    /* Sentrer side-overskrift og toppnavigasjon */
    header.wrap h1 { text-align: center; }
    header.wrap #topCount { text-align: center; }
    header.wrap nav.top { justify-content: center; }

  </style>
</head>
<body>
  <header class="wrap">
    <h1>GSI Gorillas Trening</h1>
    <p id="topCount" class="small"></p>
    <nav class="top">
      <a href="#spillere" id="nav-players">Spillere</a>
      <a href="#kamper" id="nav-matches">Kampoppsett</a>
      <a href="#score" id="nav-score">Scoreboard</a>
    </nav>
  </header>

  <main class="wrap pages">
    <!-- Spillere-siden -->
    <section class="page" id="page-players">
      <div class="card">
        <div class="inner">
          <h2 style="margin:0 0 8px">Spillere & oppmøte</h2>
          <form id="addForm" class="row">
            <input id="newName" placeholder="Nytt navn" autocomplete="off" />
            <button id="addPlayer" class="primary" type="submit" style="width:auto">Legg til (1500)</button>
          </form>
          <div class="row controls" style="margin:8px 0 6px">
            <input id="searchName" placeholder="Søk navn" autocomplete="off" style="flex:2" />
            <button id="checkAll" class="ghost" type="button">Marker alle</button>
            <button id="uncheckAll" class="ghost" type="button">Fjern alle</button>
            <button id="exportJson" class="ghost" type="button">Eksporter JSON</button>
            <button id="importJsonBtn" class="ghost" type="button">Importer JSON</button>
            <button id="resetRestAll" class="ghost" type="button" title="Sett hvile=0 for alle">Nullstill hvile</button>
            <input id="importJsonFile" type="file" accept="application/json" style="display:none" />
          </div>
          <div id="roster" class="list" aria-live="polite"></div>
          <p id="msg" class="small" aria-live="polite"></p>
          
        </div>
      </div>
    </section>

    <!-- Kampoppsett-siden -->
    <section class="page" id="page-matches">
      <div class="card">
        <div class="inner">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Kampoppsett</h2>
            <span id="meta" class="small">–</span>
          </div>
          <div class="row" style="margin-bottom:8px">
            <div>
              <label for="courts">Antall baner (valgfritt)</label>
              <input id="courts" type="number" min="1" placeholder="Auto" />
            </div>
            <div class="row" style="max-width:620px">
              <button id="nextBtn" class="primary" type="button">Neste runde</button>
              <button id="cancelRound" class="ghost" type="button" title="Avbryt pågående runde uten poengendring">Avbryt runde</button>
              
            </div>
          </div>
          <div id="schedule"></div>
        </div>
      </div>
    </section>

    <!-- Scoreboard-siden -->
    <section class="page" id="page-score">
      <div class="card">
        <div class="inner">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Scoreboard</h2>
            <div class="row" style="flex:0">
              <button class="ghost" id="exportCsv" style="width:auto">Last ned CSV</button>
            </div>
          </div>
          <div id="tableWrap"></div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ====== Konfig & helpers ====== */
const STORAGE_KEY='gsi_gorillas_routed_v1';
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
let store={players:[],config:{courts:0}};
const SCORING={win:25,draw:5,loss:-15};
let recorded=new Map(), currentRound=0, currentCourts=0, started=false;
let restingByRound={};
let searchQuery='';

const uid=()=>Math.random().toString(36).slice(2,9);
const save=()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); updateTop(); };
const load=()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){ const o=JSON.parse(raw)||{}; store.players=Array.isArray(o.players)?o.players:[]; store.config=o.config||{courts:0}; }
}catch{} updateTop(); };
const updateTop=()=>{ const c=$('#topCount'); if(c) c.textContent=`Spillere totalt: ${store.players.length}`; };
const toast=(t,k='ok')=>{ const el=$('#msg'); if(!el) return; el.textContent=t; el.className=`small ${k}`; setTimeout(()=>{el.textContent='';},2000); };

/* ====== Minirouter ====== */
function goTo(page){
  ['players','matches','score'].forEach(p=> $('#page-'+p).classList.remove('active'));
  $('#page-'+page).classList.add('active');
  // nav highlight
  $('#nav-players').classList.toggle('active', page==='players');
  $('#nav-matches').classList.toggle('active', page==='matches');
  $('#nav-score').classList.toggle('active', page==='score');
  if(page==='score') renderTable();
  if(page==='players') renderRoster();
}
window.addEventListener('hashchange', ()=>{
  const h=location.hash.replace('#','');
  if(h==='kamper') goTo('matches');
  else if(h==='score') goTo('score');
  else goTo('players');
});

/* ====== Roster ====== */
function addPlayer(name, pts=1500){
  name=(name||'').trim(); if(!name){ toast('Skriv navn','err'); return; }
  if(store.players.some(p=>p.name.toLowerCase()===name.toLowerCase())){ toast('Navnet finnes allerede','warn'); return; }
  store.players.push({id:uid(),name:name,pts:Number(pts)||1500,games:0,w:0,d:0,l:0,rest:0,present:true});
  save(); renderRoster(); renderTable(); toast(`${name} lagt til.`,'ok');
}
function setPresent(id,flag){ const p=store.players.find(x=>x.id===id); if(p){ p.present=flag; save(); renderTable(); } }
function editName(id){
  const p=store.players.find(x=>x.id===id); if(!p) return;
  const n=prompt('Rediger navn', p.name);
  if(n!==null){
    const trimmed=(n||'').trim();
    if(trimmed) p.name=trimmed;
  }
  save(); renderRoster(); renderTable();
}
function editPoints(id){
  const p=store.players.find(x=>x.id===id); if(!p) return;
  const current = String(p.pts);
  const v = prompt('Ny poengsum, eller +25/-15 for justering', current);
  if(v===null) return;
  const s = String(v).trim();
  if(!s) return;
  if(/^[-+]\\d+$/.test(s)){
    p.pts += parseInt(s,10);
  } else {
    const num = Number(s);
    if(!Number.isFinite(num)){ toast('Ugyldig tall','err'); return; }
    p.pts = num;
  }
  save(); renderRoster(); renderTable();
}
function editRest(id){
  const p=store.players.find(x=>x.id===id); if(!p) return;
  const current = String(p.rest);
  const v = prompt('Ny hvileverdi (heltall ≥ 0) eller +1/-1 for justering', current);
  if(v===null) return;
  const s = String(v).trim();
  if(!s) return;
  if(/^[-+]\\d+$/.test(s)){
    const nv = p.rest + parseInt(s,10);
    p.rest = Math.max(0, nv);
  } else {
    const num = Number(s);
    if(!Number.isInteger(num) || num < 0){ toast('Ugyldig heltall ≥ 0','err'); return; }
    p.rest = num;
  }
  save(); renderRoster(); renderTable();
}
function removePlayer(id){ if(!confirm('Fjerne spiller?')) return;
  store.players=store.players.filter(p=>p.id!==id); save(); renderRoster(); renderTable();
}

function renderRoster(){
  const root=$('#roster'); if(!root) return; root.innerHTML='';
  if(!store.players.length){ root.innerHTML='<p class="small">Ingen spillere. Legg til ovenfor.</p>'; return; }
  const rows=[...store.players]
    .filter(p=> !searchQuery || p.name.toLowerCase().includes(searchQuery))
    .sort((a,b)=> a.name.localeCompare(b.name));
  rows.forEach(p=>{
    const div=document.createElement('div'); div.className='player';
    div.innerHTML=`<input type="checkbox" class="present" data-id="${p.id}" ${p.present?'checked':''}/>
      <div>
        <div style="font-weight:600">${p.name}</div>
        <div class="small pts pts-click" data-pts="${p.id}" title="Klikk for å redigere poeng">${p.pts} poeng • hvile: ${p.rest}</div>
      </div>
      <div class="row" style="gap:6px;justify-content:flex-end;flex:0">
        <button class="menu-btn" type="button" aria-label="Meny" data-menu-for="${p.id}"></button>
      </div>
      <div class="menu" id="menu-${p.id}">
        <button data-act="name" data-id="${p.id}">Rediger navn</button>
        <button data-act="points" data-id="${p.id}">Poeng…</button>
        <button data-act="rest" data-id="${p.id}">Hvile…</button>
        <hr/>
        <button data-act="remove" data-id="${p.id}">Fjern</button>
      </div>`;
    root.appendChild(div);
  });
  $$('.present',root).forEach(cb=> cb.addEventListener('change',e=> setPresent(e.currentTarget.dataset.id,e.currentTarget.checked)));
  $$('[data-pts]',root).forEach(el=> el.addEventListener('click',()=> editPoints(el.dataset.pts)));
  $$('[data-menu-for]',root).forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const id = e.currentTarget.dataset.menuFor;
      const m = document.getElementById('menu-'+id);
      closeAllMenus();
      if(m) m.classList.toggle('open');
      e.stopPropagation();
    });
  });
  $$('#roster .menu [data-act]',root).forEach(b=> b.addEventListener('click', (e)=>{
    const act=e.currentTarget.dataset.act, id=e.currentTarget.dataset.id;
    if(act==='name') editName(id);
    else if(act==='points') editPoints(id);
    else if(act==='rest') editRest(id);
    else if(act==='remove') removePlayer(id);
    closeAllMenus();
  }));
}
function closeAllMenus(){ $$('.menu').forEach(m=> m.classList.remove('open')); }
document.addEventListener('click', closeAllMenus);

const markAll=f=>{ store.players.forEach(p=>p.present=f); save(); renderRoster(); };

/* ====== JSON Export/Import ====== */
function exportJSON(){
  const payload = {
    version: 1,
    exported_at: new Date().toISOString(),
    players: store.players,
    config: store.config
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json;charset=utf-8;'});
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `gsi-gorillas-data-${ts}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function normalizePlayer(p){
  return {
    id: p.id || uid(),
    name: String(p.name || '').trim() || 'Uten navn',
    pts: Number.isFinite(+p.pts)? +p.pts : 1500,
    games: Number.isFinite(+p.games)? +p.games : 0,
    w: Number.isFinite(+p.w)? +p.w : 0,
    d: Number.isFinite(+p.d)? +p.d : 0,
    l: Number.isFinite(+p.l)? +p.l : 0,
    rest: Number.isFinite(+p.rest)? +p.rest : 0,
    present: !!p.present
  };
}
function importJSONFile(file){

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      const players = Array.isArray(data.players) ? data.players.map(normalizePlayer) : [];
      const config = data.config && typeof data.config==='object' ? data.config : {courts:0};
      if(players.length===0){ toast('JSON mangler spillere','err'); return; }
      localStorage.setItem(STORAGE_KEY+'_backup', JSON.stringify(store));
      recorded=new Map(); currentRound=0; started=false; restingByRound={};
      const sched=$('#schedule'); if(sched) sched.innerHTML=''; $('#meta').textContent='–'; $('#nextBtn').disabled=false;
      store.players = players;
      store.config = config;
      save(); renderRoster(); renderTable();
      toast('Data importert.','ok');
    }catch(e){
      console.error(e);
      toast('Kunne ikke lese JSON','err');
    }
  };
  reader.readAsText(file, 'utf-8');
}

function resetAllRest(){
  if(!confirm('Nullstille hvile for alle spillere til 0?')) return;
  store.players.forEach(p=> p.rest = 0);
  save(); renderRoster(); renderTable();
  toast('Hvile nullstilt for alle.','ok');
}


/* ====== Plan (én runde av gangen) ====== */
const sortByPoints=a=>[...a].sort((x,y)=> y.pts-x.pts || x.name.localeCompare(y.name));
const chunk=(a,n)=>{const o=[]; for(let i=0;i<a.length;i+=n)o.push(a.slice(i,i+n)); return o};
const pairingsSeeded=g=> [ [ [g[0], g[3]], [g[1], g[2]] ] ]; // fast: 1+4 vs 2+3

function selectRestingFirst(present, cap){
  if(present.length <= cap) return { active: [...present], resting: [] };
  const byNeed = [...present].sort((a,b)=> a.rest - b.rest || Math.random() - 0.5);
  const toRest = present.length - cap;
  const resting = byNeed.slice(0, toRest);
  const active = present.filter(p => !resting.includes(p));
  return { active, resting };
}
function allResultsEntered(r){
  const ids=Array.from(recorded.keys()).filter(id=>id.startsWith(`r${r}`));
  return ids.length>0 && ids.every(id=>recorded.get(id)?.action);
}
function startPlan(){
  const present=store.players.filter(p=>p.present); if(present.length<4){ toast('Minst 4 til stede.','err'); return; }
  started=true; currentRound=0; recorded=new Map(); createRound();
}
function createRound(){
  const sched=$('#schedule'); if(sched) sched.innerHTML=''; // bare aktiv runde
  const present=store.players.filter(p=>p.present);
  if(present.length<4){ toast('For få til stede.','err'); return; }
  const cIn = parseInt($('#courts').value,10);
  const autoCourts = Math.max(1, Math.floor(present.length/4));
  currentCourts = (Number.isFinite(cIn) && cIn>0) ? Math.min(cIn, autoCourts) : autoCourts;
  const cap=currentCourts*4;
  const {active, resting} = selectRestingFirst(present, cap);
  restingByRound[currentRound] = resting.map(p=>p.id);
  resting.forEach(p=>p.rest+=1);
  const seeded = sortByPoints(active);
  const groups=chunk(seeded,4).filter(g=>g.length===4);
  if(!groups.length){ toast('Ikke nok spillere til en bane (trenger 4).','warn'); return; }

  const r=currentRound;
  const container=document.createElement('div'); container.className='matches'; container.id=`round-${r}`;
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<div class="inner"><div class="row" style="justify-content:space-between"><h3 style="margin:0">Runde ${r+1}</h3><span class="small">Hviler: ${resting.map(x=>x.name).join(', ')||'–'}</span></div></div>`;
  $('#schedule').appendChild(wrap); wrap.appendChild(container);

  groups.forEach((g,gi)=>{
    const [t1,t2]=pairingsSeeded(g)[0];
    const id=`r${r}g${gi}`;
    const el=document.createElement('div'); el.className='match';
    el.innerHTML=`<header><div><strong>Bane ${gi+1}</strong></div><div class="small" id="status-${id}">Ingen resultat</div></header>
      <div class="court">
        <div class="side">
          <div class="playerTag">`+t1.map(p=>p.name)[0]+`</div>
          <div class="playerTag">`+t1.map(p=>p.name)[1]+`</div>
        </div>
        <div class="net" aria-hidden="true"></div>
        <div class="side">
          <div class="playerTag">`+t2.map(p=>p.name)[0]+`</div>
          <div class="playerTag">`+t2.map(p=>p.name)[1]+`</div>
        </div>
      </div>
      <div class="row" style="padding:8px;border-top:1px solid #1e293b">
        <button data-action="t1" data-id="${id}">Team 1 vant</button>
        <button data-action="draw" data-id="${id}">Uavgjort</button>
        <button data-action="t2" data-id="${id}">Team 2 vant</button>
      </div>`;
    container.appendChild(el);
    recorded.set(id,{t1:t1.map(x=>x.id),t2:t2.map(x=>x.id),action:null});
  });

  $('#meta').textContent=`${present.length} tilstede • ${currentCourts} baner i bruk • Runde ${r+1}`;
  $('#nextBtn').disabled=true;
  $$('#round-'+r+' [data-action]').forEach(btn=> btn.addEventListener('click', e=>{
    const {id,action}=e.currentTarget.dataset; applyResult(id,action);
  }));
  save(); renderTable();
}
function nextRound(){
  if(!allResultsEntered(currentRound)){
    if(!confirm('Ikke alle resultater er lagt inn. Fortsette?')) return;
  }
  currentRound+=1;
  createRound();
}
function rollbackPrevious(id){
  const rec=recorded.get(id); if(!rec||!rec.action) return;
  const inv=rec.action==='t1'?'t2':rec.action==='t2'?'t1':'draw';
  scoreTeam(rec.t1,rec.t2,inv,true); rec.action=null;
}
function scoreTeam(t1Ids,t2Ids,action,rollback=false){
  const s=SCORING,d=k=>rollback?-k:k;
  const t1=t1Ids.map(id=>store.players.find(p=>p.id===id));
  const t2=t2Ids.map(id=>store.players.find(p=>p.id===id));
  if(action==='t1'){ t1.forEach(p=>{p.pts+=d(s.win);p.w+=d(1);p.games+=d(1)}); t2.forEach(p=>{p.pts+=d(s.loss);p.l+=d(1);p.games+=d(1)}); }
  else if(action==='t2'){ t2.forEach(p=>{p.pts+=d(s.win);p.w+=d(1);p.games+=d(1)}); t1.forEach(p=>{p.pts+=d(s.loss);p.l+=d(1);p.games+=d(1)}); }
  else { t1.forEach(p=>{p.pts+=d(s.draw);p.d+=d(1);p.games+=d(1)}); t2.forEach(p=>{p.pts+=d(s.draw);p.d+=d(1);p.games+=d(1)}); }
}
function applyResult(id,action){
  const rec=recorded.get(id); if(!rec) return;
  rollbackPrevious(id);
  scoreTeam(rec.t1,rec.t2,action);
  const b=document.getElementById(`status-${id}`); if(b) b.textContent= action==='t1'?'Team 1 vant': action==='t2'?'Team 2 vant':'Uavgjort';
  rec.action=action; save();
  renderTable();
  renderRoster();
  if(allResultsEntered(currentRound)) $('#nextBtn').disabled=false;
}
function cancelRound(){
  const keys = Array.from(recorded.keys()).filter(id=>id.startsWith(`r${currentRound}`));
  keys.forEach(id=>{
    const rec = recorded.get(id);
    if(rec && rec.action){ rollbackPrevious(id); }
    recorded.delete(id);
  });
  const restIds = restingByRound[currentRound] || [];
  restIds.forEach(id=>{
    const p = store.players.find(x=>x.id===id);
    if(p && p.rest>0) p.rest -= 1;
  });
  delete restingByRound[currentRound];
  const sched = document.getElementById('schedule'); if(sched) sched.innerHTML='';
  const meta = document.getElementById('meta'); if(meta) meta.textContent='–';
  const nextBtn = document.getElementById('nextBtn'); if(nextBtn) nextBtn.disabled=false;
  started=false;
  save(); renderRoster(); renderTable();
  toast('Runde avbrutt.','warn');
  goTo('players'); // tilbake til spillere
}

/* ====== Scoreboard ====== */
function renderTable(){
  const wrap=$('#tableWrap'); if(!wrap) return;
  const rows=store.players.filter(p=>p.present).sort((a,b)=> b.pts-a.pts || b.w-a.w || a.name.localeCompare(b.name));
  if(!rows.length){ wrap.innerHTML='<p class="small">Ingen til stede.</p>'; return; }
  let html='<div><table><thead><tr><th>#</th><th>Spiller</th><th>Poeng</th><th>Kamper</th><th>V</th><th>U</th><th>T</th><th>Hvile</th><th>Til stede</th></tr></thead><tbody>';
  rows.forEach((r,i)=> html+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.pts}</td><td>${r.games}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td>${r.rest}</td><td>${r.present?'✔️':''}</td></tr>`);
  wrap.innerHTML=html+'</tbody></table></div>';
}
function exportCSV(){
  const rows=[...store.players].sort((a,b)=> b.pts-a.pts || a.name.localeCompare(b.name));
  const header='Plass;Spiller;Poeng;Kamper;V;U;T;Hvile;Tilstede\n';
  const body=rows.map((r,i)=>`${i+1};${r.name};${r.pts};${r.games};${r.w};${r.d};${r.l};${r.rest};${r.present?1:0}`).join('\n');
  const blob=new Blob([header+body],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='gsi-gorillas-scoreboard.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== Init ====== */
window.addEventListener('DOMContentLoaded', ()=>{
  load(); renderRoster(); renderTable();

  // Nav links
  $('#nav-players').addEventListener('click', ()=> goTo('players'));
  $('#nav-matches').addEventListener('click', ()=> goTo('matches'));
  $('#nav-score').addEventListener('click', ()=> goTo('score'));

  // Start page from hash
  const h=location.hash.replace('#','');
  if(h==='kamper') goTo('matches');
  else if(h==='score') goTo('score');
  else goTo('players');

  // Add player flow
  const form  = document.getElementById('addForm');
  const input = document.getElementById('newName');
  const btn   = document.getElementById('addPlayer');

  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const v = (input.value || '').trim();
    if (!v) return;
    addPlayer(v);
    input.value = '';
    input.focus();
  });
  btn.addEventListener('click', (e)=>{ e.preventDefault(); form.requestSubmit(); });

  // Roster controls
  const resetBtn = document.getElementById('resetRestAll');
  if(resetBtn){ resetBtn.addEventListener('click', resetAllRest); }
  document.getElementById('checkAll').addEventListener('click', ()=> markAll(true));
  document.getElementById('uncheckAll').addEventListener('click', ()=> markAll(false));
  const searchEl = document.getElementById('searchName');
  searchEl.addEventListener('input', (e)=>{
    searchQuery = (e.target.value||'').toLowerCase();
    renderRoster();
  });

  // JSON IO
  document.getElementById('exportJson').addEventListener('click', exportJSON);
  const fileInput = document.getElementById('importJsonFile');
  document.getElementById('importJsonBtn').addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', (e)=>{
    if(e.target.files && e.target.files[0]) importJSONFile(e.target.files[0]);
    e.target.value=''; // tillat re-import av samme fil
  });

  // Matches page buttons
  const nextBtn = document.getElementById('nextBtn');
  nextBtn.addEventListener('click', ()=>{
    if(!started){ startPlan(); }
    else { nextRound(); }
  });
  document.getElementById('cancelRound').addEventListener('click', cancelRound);

  // Players page navigation buttons

  // Scoreboard page buttons
  document.getElementById('exportCsv').addEventListener('click', exportCSV);
});
</script>
</body>
</html>

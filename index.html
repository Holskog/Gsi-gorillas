<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Beat the Box – oppmøte, én runde av gangen</title>
  <style>
    :root{--bg:#0b1016;--card:#121924;--muted:#94a3b8;--text:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:1px solid #18202b}
    h1{margin:0;font-size:clamp(22px,4vw,28px)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:1000px){.grid{grid-template-columns:420px 1fr}}
    .card{background:#121924;border:1px solid #1e293b;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card .inner{padding:14px}
    label{display:block;font-size:12px;color:#94a3b8;margin:8px 0 6px}
    input,button{border-radius:10px;border:1px solid #253346;background:#0f172a;color:#e5e7eb;padding:10px 12px}
    button{cursor:pointer}
    .primary{background:#2563eb;border:0}
    .ghost{background:transparent;border:1px dashed #334155}
    .row{display:flex;gap:8px;align-items:center}
    .row>*{flex:1}
    .list{display:grid;gap:6px;max-height:420px;overflow:auto}
    .player{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid #223046;border-radius:10px;background:#0d1524}
    .small{font-size:12px;color:#94a3b8}
    .matches{display:grid;gap:10px}
    .match{border:1px solid #233049;border-radius:12px;overflow:hidden;background:#0e1626}
    .match header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #1e293b}
    .teams{padding:10px 12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #1f2a33;text-align:left}
    th{position:sticky;top:0;background:#0f172a}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Beat the Box – oppmøte & kamper</h1>
    <p class="small">Legg til spillere → huk av oppmøte → lag én runde → registrér resultat → neste runde. Poeng 25/5/−15 (start 1500). Lagring i nettleser.</p>
    <p id="topCount" class="small"></p>
  </header>

  <main class="wrap grid">
    <!-- Spillere & oppmøte -->
    <section class="card">
      <div class="inner">
        <h2>Spillere & oppmøte</h2>
        <form id="addForm" class="row">
          <input id="newName" placeholder="Nytt navn" autocomplete="off" />
          <button id="addPlayer" class="primary" type="submit" style="width:auto">Legg til (1500)</button>
        </form>
        <div class="row" style="margin:8px 0 6px">
          <button id="checkAll" class="ghost" type="button">Marker alle</button>
          <button id="uncheckAll" class="ghost" type="button">Fjern alle</button>
          <button id="invertCheck" class="ghost" type="button">Inverter</button>
          <button id="seedDemo" class="ghost" type="button">Legg inn 8 demo</button>
        </div>
        <div id="roster" class="list" aria-live="polite"></div>
        <p id="msg" class="small" aria-live="polite"></p>
      </div>
    </section>

    <!-- Plan -->
    <section class="card">
      <div class="inner">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Plan</h2>
          <span id="meta" class="small">–</span>
        </div>
        <div class="row" style="margin-bottom:8px">
          <div>
            <label for="courts">Antall baner (valgfritt)</label>
            <input id="courts" type="number" min="1" placeholder="Auto" />
          </div>
          <div class="row" style="max-width:420px">
            <button id="generateFirst" class="primary" type="button">Start – lag 1. runde</button>
            <button id="nextRound" class="ghost" type="button" disabled>Neste runde</button>
          </div>
        </div>
        <div id="schedule"></div>
      </div>
    </section>

    <!-- Scoreboard -->
    <section class="card">
      <div class="inner">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Scoreboard</h2>
          <button class="ghost" id="exportCsv" style="width:auto">Last ned CSV</button>
        </div>
        <div id="tableWrap"></div>
      </div>
    </section>
  </main>

<script>
/* ====== Konfig & helpers ====== */
const STORAGE_KEY='btb_padel_semester_onefile_v2';
const $=(s,el=document)=>el.querySelector(s);
const $$=(s,el=document)=>Array.from(el.querySelectorAll(s));
let store={players:[],config:{courts:0}};
const SCORING={win:25,draw:5,loss:-15};
let recorded=new Map(), currentRound=0, currentCourts=0;

const uid=()=>Math.random().toString(36).slice(2,9);
const save=()=>{ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); updateTop(); };
const load=()=>{ try{ const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){ const o=JSON.parse(raw)||{}; store.players=Array.isArray(o.players)?o.players:[]; store.config=o.config||{courts:0}; }
}catch{} updateTop(); };
const updateTop=()=>{ const c=$('#topCount'); if(c) c.textContent=`Spillere totalt: ${store.players.length}`; };
const toast=(t,k='ok')=>{ const el=$('#msg'); if(!el) return; el.textContent=t; el.className=`small ${k}`; setTimeout(()=>{el.textContent='';},2500); };

/* ====== Roster ====== */
function addPlayer(name, pts=1500){
  name=(name||'').trim(); if(!name){ toast('Skriv navn','err'); return; }
  if(store.players.some(p=>p.name.toLowerCase()===name.toLowerCase())){ toast('Navnet finnes allerede','warn'); return; }
  store.players.push({id:uid(),name,pts:Number(pts)||1500,games:0,w:0,d:0,l:0,rest:0,present:true});
  save(); renderRoster(); renderTable(); toast(`${name} lagt til.`,'ok');
}
function setPresent(id,flag){ const p=store.players.find(x=>x.id===id); if(p){ p.present=flag; save(); renderTable(); } }
function editPlayer(id){
  const p=store.players.find(x=>x.id===id); if(!p) return;
  const n=prompt('Rediger navn',p.name); if(n!==null){ p.name=(n||'').trim()||p.name; }
  const v=prompt('Rediger poeng',p.pts); if(v!==null && v!==''){ const num=Number(v); if(!Number.isNaN(num)) p.pts=num; }
  save(); renderRoster(); renderTable();
}
function removePlayer(id){ if(!confirm('Fjerne spiller?')) return;
  store.players=store.players.filter(p=>p.id!==id); save(); renderRoster(); renderTable();
}
function renderRoster(){
  const root=$('#roster'); root.innerHTML='';
  if(!store.players.length){ root.innerHTML='<p class="small">Ingen spillere. Legg til ovenfor.</p>'; return; }
  const rows=[...store.players].sort((a,b)=> b.pts-a.pts || a.name.localeCompare(b.name));
  rows.forEach(p=>{
    const div=document.createElement('div'); div.className='player';
    div.innerHTML=`<input type="checkbox" class="present" data-id="${p.id}" ${p.present?'checked':''}/>
      <div><div style="font-weight:600">${p.name}</div><div class="small">${p.pts} poeng</div></div>
      <div class="row" style="gap:6px;justify-content:flex-end">
        <button data-edit="${p.id}" type="button">Rediger</button>
        <button data-del="${p.id}" type="button">Fjern</button>
      </div>`;
    root.appendChild(div);
  });
  $$('.present',root).forEach(cb=> cb.addEventListener('change',e=> setPresent(e.currentTarget.dataset.id,e.currentTarget.checked)));
  $$('[data-edit]',root).forEach(b=> b.addEventListener('click',()=>editPlayer(b.dataset.edit)));
  $$('[data-del]',root).forEach(b=> b.addEventListener('click',()=>removePlayer(b.dataset.del)));
}
const markAll=f=>{ store.players.forEach(p=>p.present=f); save(); renderRoster(); };
const invertMarks=()=>{ store.players.forEach(p=>p.present=!p.present); save(); renderRoster(); };

/* ====== Plan (én runde av gangen) ====== */
const sortByPoints=a=>[...a].sort((x,y)=> y.pts-x.pts || x.name.localeCompare(y.name));
const chunk=(a,n)=>{const o=[]; for(let i=0;i<a.length;i+=n)o.push(a.slice(i,i+n)); return o};
const pairingsSeeded=g=>[ [[g[0],g[3]],[g[1],g[2]]], [[g[0],g[2]],[g[1],g[3]]], [[g[0],g[1]],[g[2],g[3]]] ];
function selectActivePlayers(players,cap){
  if(players.length<=cap) return {active:[...players],resting:[]};
  const sorted=[...players].sort((a,b)=> a.rest-b.rest || Math.random()-0.5);
  const toRest=players.length-cap; const resting=sorted.slice(0,toRest);
  const active=players.filter(p=>!resting.includes(p)); return {active,resting};
}
function startPlan(){
  const present=store.players.filter(p=>p.present); if(present.length<4){ toast('Minst 4 til stede.','err'); return; }
  const cIn=parseInt($('#courts').value,10);
  currentCourts=Number.isFinite(cIn)&&cIn>0?cIn:Math.max(1,Math.floor(present.length/4));
  currentRound=0; recorded=new Map(); createRound();
}
function allResultsEntered(r){
  const ids=Array.from(recorded.keys()).filter(id=>id.startsWith(`r${r}`));
  return ids.length>0 && ids.every(id=>recorded.get(id)?.action);
}
function createRound(){
  $('#schedule').innerHTML=''; // bare aktiv runde
  const cap=currentCourts*4;
  const present=store.players.filter(p=>p.present); if(present.length<4){ toast('For få til stede.','err'); return; }

  // VELG på nytt hver runde basert på OPPDATERTE poeng:
  const {active,resting}=selectActivePlayers(sortByPoints(present),cap);
  resting.forEach(p=>p.rest+=1);

  const groups=chunk(sortByPoints(active),4).filter(g=>g.length===4);
  const r=currentRound;
  const container=document.createElement('div'); container.className='matches'; container.id=`round-${r}`;
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`<div class="inner"><div class="row" style="justify-content:space-between"><h3 style="margin:0">Runde ${r+1}</h3><span class="small">Hviler: ${resting.map(x=>x.name).join(', ')||'–'}</span></div></div>`;
  $('#schedule').appendChild(wrap); wrap.appendChild(container);

  groups.forEach((g,gi)=>{
    const [t1,t2]=pairingsSeeded(g)[r%3]; // 1+4 vs 2+3, så rotasjon
    const id=`r${r}g${gi}`;
    const el=document.createElement('div'); el.className='match';
    el.innerHTML=`<header><div><strong>Bane ${gi+1}</strong></div><div class="small" id="status-${id}">Ingen resultat</div></header>
      <div class="teams">${t1.map(p=>p.name).join(' + ')} <span class="small">vs</span> ${t2.map(p=>p.name).join(' + ')}</div>
      <div class="row" style="padding:8px;border-top:1px solid #1e293b">
        <button data-action="t1" data-id="${id}">Team 1 vant</button>
        <button data-action="draw" data-id="${id}">Uavgjort</button>
        <button data-action="t2" data-id="${id}">Team 2 vant</button>
      </div>`;
    container.appendChild(el);
    recorded.set(id,{t1:t1.map(x=>x.id),t2:t2.map(x=>x.id),action:null});
  });

  $('#meta').textContent=`${present.length} tilstede • ${currentCourts} baner • Runde ${r+1}`;
  $('#nextRound').disabled=true;
  $$('#round-'+r+' [data-action]').forEach(btn=> btn.addEventListener('click', e=>{
    const {id,action}=e.currentTarget.dataset; applyResult(id,action);
  }));
  save(); renderTable(); // viser ferske tall i tabell
}
function nextRound(){
  if(!allResultsEntered(currentRound)){
    if(!confirm('Ikke alle resultater er lagt inn. Fortsette?')) return;
  }
  currentRound+=1;
  createRound();
}
function rollbackPrevious(id){
  const rec=recorded.get(id); if(!rec||!rec.action) return;
  const inv=rec.action==='t1'?'t2':rec.action==='t2'?'t1':'draw';
  scoreTeam(rec.t1,rec.t2,inv,true); rec.action=null;
}
function scoreTeam(t1Ids,t2Ids,action,rollback=false){
  const s=SCORING,d=k=>rollback?-k:k;
  const t1=t1Ids.map(id=>store.players.find(p=>p.id===id));
  const t2=t2Ids.map(id=>store.players.find(p=>p.id===id));
  if(action==='t1'){ t1.forEach(p=>{p.pts+=d(s.win);p.w+=d(1);p.games+=d(1)}); t2.forEach(p=>{p.pts+=d(s.loss);p.l+=d(1);p.games+=d(1)}); }
  else if(action==='t2'){ t2.forEach(p=>{p.pts+=d(s.win);p.w+=d(1);p.games+=d(1)}); t1.forEach(p=>{p.pts+=d(s.loss);p.l+=d(1);p.games+=d(1)}); }
  else { t1.forEach(p=>{p.pts+=d(s.draw);p.d+=d(1);p.games+=d(1)}); t2.forEach(p=>{p.pts+=d(s.draw);p.d+=d(1);p.games+=d(1)}); }
}
function applyResult(id,action){
  const rec=recorded.get(id); if(!rec) return;
  rollbackPrevious(id);
  scoreTeam(rec.t1,rec.t2,action);
  const b=document.getElementById(`status-${id}`); if(b) b.textContent= action==='t1'?'Team 1 vant': action==='t2'?'Team 2 vant':'Uavgjort';
  rec.action=action; save();
  renderTable();  // oppdatér tabell
  renderRoster(); // oppdatér poeng under navn
  if(allResultsEntered(currentRound)) $('#nextRound').disabled=false;
}

/* ====== Scoreboard ====== */
function renderTable(){
  const wrap=$('#tableWrap');
  const rows=[...store.players].sort((a,b)=> b.pts-a.pts || b.w-a.w || a.name.localeCompare(b.name));
  if(!rows.length){ wrap.innerHTML='<p class="small">Ingen spillere.</p>'; return; }
  let html='<div style="overflow:auto"><table><thead><tr><th>#</th><th>Spiller</th><th>Poeng</th><th>Kamper</th><th>V</th><th>U</th><th>T</th><th>Hvile</th><th>Til stede</th></tr></thead><tbody>';
  rows.forEach((r,i)=> html+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.pts}</td><td>${r.games}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td>${r.rest}</td><td>${r.present?'✔️':''}</td></tr>`);
  wrap.innerHTML=html+'</tbody></table></div>';
}
function exportCSV(){
  const rows=[...store.players].sort((a,b)=> b.pts-a.pts || a.name.localeCompare(b.name));
  const header='Plass;Spiller;Poeng;Kamper;V;U;T;Hvile;Tilstede\n';
  const body=rows.map((r,i)=>`${i+1};${r.name};${r.pts};${r.games};${r.w};${r.d};${r.l};${r.rest};${r.present?1:0}`).join('\n');
  const blob=new Blob([header+body],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='beat-the-box-scoreboard.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ====== Init – enkel og stabil ====== */
window.addEventListener('DOMContentLoaded', ()=>{
  load(); renderRoster(); renderTable();

  const form  = document.getElementById('addForm');
  const input = document.getElementById('newName');
  const btn   = document.getElementById('addPlayer');

  // ÉN sann flyt: alt går via submit
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const v = (input.value || '').trim();
    if (!v) return;
    addPlayer(v);
    input.value = '';
    input.focus();
  });
  btn.addEventListener('click', (e)=>{ e.preventDefault(); form.requestSubmit(); });

  document.getElementById('checkAll').addEventListener('click', ()=> markAll(true));
  document.getElementById('uncheckAll').addEventListener('click', ()=> markAll(false));
  document.getElementById('invertCheck').addEventListener('click', invertMarks);
  document.getElementById('seedDemo').addEventListener('click', ()=>{
    ['Ola','Kari','Per','Anne','Mats','Ida','Siri','Jon'].forEach(n=>{
      if(!store.players.some(p=>p.name===n))
        store.players.push({id:uid(),name:n,pts:1500,games:0,w:0,d:0,l:0,rest:0,present:true});
    });
    save(); renderRoster(); renderTable();
  });

  document.getElementById('generateFirst').addEventListener('click', startPlan);
  document.getElementById('nextRound').addEventListener('click', nextRound);
  document.getElementById('exportCsv').addEventListener('click', exportCSV);
});
</script>
</body>
</html>
